<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orders Overview - GoGrocery Manager</title>
    <link rel="stylesheet" href="../../assets/css/common/base.css" />
    <link rel="stylesheet" href="../../assets/css/common/components.css" />
    <link rel="stylesheet" href="../../assets/css/manager/layout.css" />
    <link rel="stylesheet" href="../../assets/css/manager/shops.css" />
  </head>
  <body>
    <div class="manager-dashboard">
      <!-- Sidebar -->
      <aside class="manager-sidebar">
        <nav class="manager-sidebar-nav">
          <div class="manager-nav-section">
            <div class="manager-nav-title">Overview</div>
            <a href="dashboard.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
          </div>

          <div class="manager-nav-section">
            <div class="manager-nav-title">Management</div>
            <a href="shops.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              Shop Oversight
            </a>
            <a href="orders.html" class="manager-nav-link active">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              Orders Overview
            </a>
          </div>

          <div class="manager-nav-section">
            <div class="manager-nav-title">Account</div>
            <a href="../common/profile.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              My Profile
            </a>
            <a href="#" class="manager-nav-link" id="logout-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Logout
            </a>
          </div>
        </nav>
      </aside>

      <!-- Sidebar Overlay -->
      <div class="manager-sidebar-overlay"></div>

      <!-- Main Content -->
      <main class="manager-main">
        <!-- Top Header -->
        <header class="manager-top-header">
          <div class="manager-header-left">
            <button class="manager-sidebar-toggle">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <h1 class="manager-page-title">Orders Overview</h1>
          </div>

          <div class="manager-header-right">
            <div class="manager-header-profile">
              <img
                src="/placeholder.svg?height=40&width=40"
                alt="Manager"
                class="manager-avatar"
              />
              <div class="manager-profile-info">
                <div class="manager-profile-name">Sarah Manager</div>
                <div class="manager-profile-role">Manager</div>
              </div>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="manager-content">
          <!-- Page Header -->
          <div class="manager-page-header">
            <div class="manager-page-header-info">
              <h1>Orders Overview</h1>
            </div>
          </div>

          <!-- Orders Table -->
          <div class="manager-card">
            <div class="manager-card-body" style="padding: 0">
              <div class="manager-table-container">
                <table class="manager-table">
                  <thead>
                    <tr>
                      <th>Order ID</th>
                      <th>Customer</th>
                      <th>Shop</th>
                      <th>Items</th>
                      <th>Total</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="orders-table-body">
                    <!-- Dynamic Content -->
                    <tr>
                      <td colspan="8" style="text-align: center; padding: 2rem">
                        Loading orders...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Order Detail/Status Modal -->
    <div class="modal-overlay" id="order-modal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            Order Details: #<span id="modal-order-id"></span>
          </h3>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="order-info-grid">
            <div>
              <p>
                <strong>Customer:</strong> <span id="modal-customer"></span>
              </p>
              <p><strong>Shop:</strong> <span id="modal-shop"></span></p>
              <p><strong>Date:</strong> <span id="modal-date"></span></p>
            </div>
            <div>
              <p><strong>Total:</strong> $<span id="modal-total"></span></p>
              <p><strong>Method:</strong> <span id="modal-method"></span></p>
              <p><strong>Address:</strong> <span id="modal-address"></span></p>
            </div>
          </div>

          <h4 style="margin-top: 16px; margin-bottom: 8px">Items</h4>
          <div
            id="modal-items-list"
            style="
              border: 1px solid #eee;
              padding: 10px;
              max-height: 150px;
              overflow-y: auto;
              margin-bottom: 16px;
            "
          ></div>

          <div class="form-group">
            <label class="form-label">Update Status</label>
            <select class="form-input" id="modal-status-select">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="delivering">Delivering</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-outline"
              id="btn-delete-order"
              style="border-color: red; color: red; margin-right: auto"
            >
              Delete Order
            </button>
            <button type="button" class="btn btn-primary" id="btn-save-status">
              Update Status
            </button>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-container {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .order-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
      }
    </style>

    <script>
      // Sidebar
      const sidebarToggle = document.querySelector(".manager-sidebar-toggle");
      const sidebar = document.querySelector(".manager-sidebar");
      const overlay = document.querySelector(".manager-sidebar-overlay");
      if (sidebarToggle)
        sidebarToggle.addEventListener("click", () => {
          sidebar.classList.toggle("active");
          overlay.classList.toggle("active");
        });
      if (overlay)
        overlay.addEventListener("click", () => {
          sidebar.classList.remove("active");
          overlay.classList.remove("active");
        });

      // Logout Logic
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await api({ data_type: "logout" });
          window.location.href = "../common/login.html";
        });
      }

      // Modal Elements
      const modal = document.getElementById("order-modal");
      const btnClose = document.getElementById("modal-close");
      const btnSave = document.getElementById("btn-save-status");
      const btnDelete = document.getElementById("btn-delete-order");

      let currentOrder = null;

      const openModal = (order) => {
        currentOrder = order;
        document.getElementById("modal-order-id").textContent = order.id;
        document.getElementById("modal-customer").textContent =
          order.customer_name || "N/A";
        document.getElementById("modal-shop").textContent =
          order.shop_name || "N/A";
        document.getElementById("modal-date").textContent =
          order.created_at || "N/A";
        document.getElementById("modal-total").textContent = parseFloat(
          order.amount,
        ).toFixed(2);
        document.getElementById("modal-method").textContent = order.method;
        document.getElementById("modal-address").textContent = "N/A"; // ideally fetch from customer table if available

        document.getElementById("modal-status-select").value = order.status;

        // Items would ideally be fetched if not present in order object.
        // For now showing simple count or placeholder if items detail not in get_orders (usually get_orders serves summary)
        const itemsList = document.getElementById("modal-items-list");
        itemsList.innerHTML =
          "<p><em>Items details not loaded in summary.</em></p>";

        modal.classList.add("active");
      };

      const closeModal = () => {
        modal.classList.remove("active");
        currentOrder = null;
      };

      if (btnClose) btnClose.addEventListener("click", closeModal);

      // API
      const api = async (data) => {
        try {
          const r = await fetch("../../backend/api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          return await r.json();
        } catch (e) {
          console.error(e);
          return { error: true };
        }
      };

      const statusClass = (s) => {
        if (!s) return "";
        s = s.toLowerCase();
        if (s.includes("process") || s.includes("pending")) return "warning";
        if (s.includes("out") || s.includes("deliver")) return "info";
        if (s.includes("deliv") || s.includes("complete") || s.includes("paid"))
          return "success";
        if (s.includes("cancel") || s.includes("reject")) return "error";
        return "";
      };

      const init = async () => {
        const ui = await api({ data_type: "user_info" });
        if (!ui.logged_in || ui.user.role !== "manager") {
          window.location.href = "../common/login.html";
          return;
        }

        document.querySelector(".manager-profile-name").textContent =
          ui.user.name;
        document.querySelector(".manager-avatar").src =
          ui.user.image || "/placeholder.svg?height=40&width=40";
        document.querySelector(".manager-profile-role").textContent =
          ui.user.role;

        loadOrders();
      };

      const loadOrders = async () => {
        const res = await api({ data_type: "get_orders" });
        const tbody = document.getElementById("orders-table-body");
        tbody.innerHTML = "";

        if (!res.orders || res.orders.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='8' style='text-align:center'>No orders found.</td></tr>";
          return;
        }

        res.orders.forEach((o) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                <td><strong>#ORD-${o.id}</strong></td>
                <td>
                  <div class="manager-shop-info">
                    <img src="/placeholder.svg?height=36&width=36" alt="C" class="manager-shop-logo" style="width:36px;height:36px" />
                    <div>
                      <div class="manager-shop-name">${o.customer_name || "Unknown"}</div>
                      <div class="manager-shop-owner">ID: ${o.customerId}</div>
                    </div>
                  </div>
                </td>
                <td>${o.shop_name || "Unknown"}</td>
                <td>- items</td>
                <td><strong>$${parseFloat(o.amount).toFixed(2)}</strong></td>
                <td><span class="status-badge ${statusClass(o.status)}">${o.status}</span></td>
                <td>${o.created_at || ""}</td>
                <td><button class="btn btn-outline btn-sm btn-view" data-obj='${JSON.stringify(o).replace(/'/g, "&#39;")}'>Manage</button></td>
              `;
          tbody.appendChild(tr);
        });

        document.querySelectorAll(".btn-view").forEach((b) => {
          b.addEventListener("click", () => {
            const o = JSON.parse(b.dataset.obj);
            openModal(o);
          });
        });
      };

      btnSave.addEventListener("click", async () => {
        if (!currentOrder) return;
        const newStatus = document.getElementById("modal-status-select").value;
        const res = await api({
          data_type: "update_order",
          id: currentOrder.id,
          status: newStatus,
        });
        if (res.message) alert(res.message);
        closeModal();
        loadOrders();
      });

      btnDelete.addEventListener("click", async () => {
        if (!currentOrder) return;
        if (
          !confirm(
            "Are you sure you want to PERMANENTLY delete this order? This cannot be undone.",
          )
        )
          return;

        const res = await api({
          data_type: "delete_order",
          id: currentOrder.id,
        });
        if (res.message) alert(res.message);
        closeModal();
        loadOrders();
      });

      init();
    </script>
  </body>
</html>
