<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop Oversight - GoGrocery Manager</title>
    <link rel="stylesheet" href="../../assets/css/common/base.css" />
    <link rel="stylesheet" href="../../assets/css/common/components.css" />
    <link rel="stylesheet" href="../../assets/css/manager/layout.css" />
    <link rel="stylesheet" href="../../assets/css/manager/shops.css" />
  </head>
  <body>
    <div class="manager-dashboard">
      <!-- Sidebar -->
      <aside class="manager-sidebar">
        <nav class="manager-sidebar-nav">
          <div class="manager-nav-section">
            <div class="manager-nav-title">Overview</div>
            <a href="dashboard.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
          </div>

          <div class="manager-nav-section">
            <div class="manager-nav-title">Management</div>
            <a href="shops.html" class="manager-nav-link active">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              Shop Oversight
            </a>
            <a href="orders.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              Orders Overview
            </a>
          </div>

          <div class="manager-nav-section">
            <div class="manager-nav-title">Account</div>
            <a href="../common/profile.html" class="manager-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              My Profile
            </a>
            <a href="#" class="manager-nav-link" id="logout-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Logout
            </a>
          </div>
        </nav>
      </aside>

      <!-- Sidebar Overlay -->
      <div class="manager-sidebar-overlay"></div>

      <!-- Main Content -->
      <main class="manager-main">
        <!-- Top Header -->
        <header class="manager-top-header">
          <div class="manager-header-left">
            <button class="manager-sidebar-toggle">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <h1 class="manager-page-title">Shop Oversight</h1>
          </div>

          <div class="manager-header-right">
            <div class="manager-header-profile">
              <img
                src="/placeholder.svg?height=40&width=40"
                alt="Manager"
                class="manager-avatar"
              />
              <div class="manager-profile-info">
                <div class="manager-profile-name">Sarah Manager</div>
                <div class="manager-profile-role">Manager</div>
              </div>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="manager-content">
          <!-- Page Header -->
          <div class="manager-page-header">
            <div class="manager-page-header-info">
              <h1>Shop Oversight</h1>
            </div>
            <div class="manager-page-header-actions">
              <button class="btn btn-primary" id="btn-add-shop">
                Add New Shop
              </button>
            </div>
          </div>

          <!-- Shops Grid -->
          <div class="manager-shops-grid" id="shops-grid">
            <!-- Dynamic content loaded here -->
            <div style="grid-column: 1/-1; text-align: center; padding: 2rem">
              Loading shops...
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Shop Modal -->
    <div class="modal-overlay" id="shop-modal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title" id="shop-modal-title">Add New Shop</h3>
          <button class="modal-close" id="shop-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="shop-form">
            <input type="hidden" id="shop-id" name="id" />
            <div class="form-group">
              <label class="form-label">Shop Name</label>
              <input type="text" class="form-input" id="shop-name" required />
            </div>
            <div class="form-group">
              <label class="form-label">Location</label>
              <input
                type="text"
                class="form-input"
                id="shop-location"
                required
              />
            </div>
            <!-- Manager can optionally assign an Owner ID if they know it, or leave it blank -->
            <div class="form-group">
              <label class="form-label">Owner User ID (Optional)</label>
              <input
                type="number"
                class="form-input"
                id="shop-user-id"
                placeholder="User ID of owner"
              />
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-outline"
                id="shop-modal-cancel"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Save Shop</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-container {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        width: 100%;
        max-width: 500px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
      }
    </style>

    <script>
      // Sidebar
      const sidebarToggle = document.querySelector(".manager-sidebar-toggle");
      const sidebar = document.querySelector(".manager-sidebar");
      const overlay = document.querySelector(".manager-sidebar-overlay");
      if (sidebarToggle)
        sidebarToggle.addEventListener("click", () => {
          sidebar.classList.toggle("active");
          overlay.classList.toggle("active");
        });
      if (overlay)
        overlay.addEventListener("click", () => {
          sidebar.classList.remove("active");
          overlay.classList.remove("active");
        });

      // Logout Logic
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await api({ data_type: "logout" });
          window.location.href = "../common/login.html";
        });
      }

      // Modal
      const modal = document.getElementById("shop-modal");
      const modalTitle = document.getElementById("shop-modal-title");
      const shopForm = document.getElementById("shop-form");
      const btnAdd = document.getElementById("btn-add-shop");
      const btnClose = document.getElementById("shop-modal-close");
      const btnCancel = document.getElementById("shop-modal-cancel");

      const openModal = (title) => {
        modalTitle.textContent = title;
        modal.classList.add("active");
      };
      const closeModal = () => {
        modal.classList.remove("active");
        shopForm.reset();
        document.getElementById("shop-id").value = "";
      };

      btnAdd.addEventListener("click", () => openModal("Add New Shop"));
      btnClose.addEventListener("click", closeModal);
      btnCancel.addEventListener("click", closeModal);

      // API
      const api = async (data) => {
        try {
          const r = await fetch("../../backend/api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          return await r.json();
        } catch (e) {
          console.error(e);
          return { error: true };
        }
      };

      // INIT
      const init = async () => {
        const ui = await api({ data_type: "user_info" });
        if (!ui.logged_in || ui.user.role !== "manager") {
          window.location.href = "../common/login.html";
          return;
        }

        document.querySelector(".manager-profile-name").textContent =
          ui.user.name;
        document.querySelector(".manager-avatar").src =
          ui.user.image || "/placeholder.svg?height=40&width=40";
        document.querySelector(".manager-profile-role").textContent =
          ui.user.role;

        loadShops();
      };

      const loadShops = async () => {
        const res = await api({ data_type: "get_shops" });
        const grid = document.getElementById("shops-grid");
        grid.innerHTML = "";

        if (!res.shops || res.shops.length === 0) {
          grid.innerHTML = "<p>No shops found.</p>";
          return;
        }

        // Fetch orders to display count (optional, can be separate call for performance but helpful here)
        const ordRes = await api({ data_type: "get_orders" });
        const allOrders = ordRes.orders || [];

        res.shops.forEach((s) => {
          const sOrders = allOrders.filter((o) => o.shopId == s.id).length;

          const card = document.createElement("div");
          card.className = "manager-shop-card";
          card.innerHTML = `
                <div class="manager-shop-header">
                  <img src="/placeholder.svg?height=80&width=80" alt="${s.name}" class="manager-shop-logo-lg" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />
                  <span class="manager-shop-status-badge">
                  </span>
                </div>
                <div class="manager-shop-body">
                  <h3 class="manager-shop-title">${s.name}</h3>
                  <div class="manager-shop-meta">
                     <div class="manager-shop-meta-item">üìç ${s.location}</div>
                  </div>
                  <div class="manager-shop-stats">
                     <div class="manager-shop-stat">
                        <div class="manager-shop-stat-value">${sOrders}</div>
                        <div class="manager-shop-stat-label">Orders</div>
                     </div>
                  </div>
                </div>
                <div class="manager-shop-actions">
                    <button class="btn btn-primary btn-sm btn-edit" data-id="${s.id}" data-name="${s.name}" data-loc="${s.location}" data-uid="${s.user_id || ""}">Edit</button>
                    <button class="btn btn-outline btn-sm btn-delete" data-id="${s.id}" style="border-color: #ef4444; color: #ef4444;">Delete</button>
                </div>
              `;
          grid.appendChild(card);
        });

        // Attach handlers
        document.querySelectorAll(".btn-edit").forEach((b) => {
          b.addEventListener("click", (e) => {
            const d = e.target.dataset;
            document.getElementById("shop-id").value = d.id;
            document.getElementById("shop-name").value = d.name;
            document.getElementById("shop-location").value = d.loc;
            document.getElementById("shop-user-id").value = d.uid;
            openModal("Edit Shop");
          });
        });

        document.querySelectorAll(".btn-delete").forEach((b) => {
          b.addEventListener("click", async (e) => {
            if (!confirm("Are you sure you want to delete this shop?")) return;
            const id = e.target.dataset.id;
            const res = await api({ data_type: "delete_shop", id: id });
            if (res.message) alert(res.message);
            loadShops();
          });
        });
      };

      shopForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("shop-id").value;
        const name = document.getElementById("shop-name").value;
        const loc = document.getElementById("shop-location").value;
        const uid = document.getElementById("shop-user-id").value;

        const data = {
          data_type: id ? "update_shop" : "add_shop",
          name: name,
          location: loc,
          user_id: uid,
        };
        if (id) data.id = id;

        const res = await api(data);
        if (res.message) alert(res.message);
        closeModal();
        loadShops();
      });

      init();
    </script>
  </body>
</html>
