<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart - GoGrocery</title>
    <link rel="stylesheet" href="../../assets/css/common/base.css" />
    <link rel="stylesheet" href="../../assets/css/common/components.css" />
    <link rel="stylesheet" href="../../assets/css/customer/layout.css" />
    <link rel="stylesheet" href="../../assets/css/customer/cart.css" />
    <script>
      async function api(body){
        try{
          const res = await fetch('../../backend/api.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
          return await res.json();
        }catch(e){ return null; }
      }

      function formatMoney(v){ return '$' + parseFloat(v).toFixed(2); }

      async function loadCart(){
        const res = await api({data_type: 'get_cart'});
        const list = document.querySelector('.cart-list');
        const countEl = document.querySelector('.cart-count');
        const subtotalEl = document.querySelector('.summary-subtotal');
        const itemsEl = document.querySelector('.summary-items');
        const totalEl = document.querySelector('.summary-total-amount');

        list.innerHTML = '';
        if(!res || !res.items || res.items.length === 0){
          list.innerHTML = '<p>Your cart is empty.</p>';
          countEl.textContent = '0'; itemsEl.textContent = '0'; subtotalEl.textContent = '$0.00'; totalEl.textContent = '$0.00';
          return;
        }

        let subtotal = 0; let items = 0;
        res.items.forEach(item => {
          items += item.quantity;
          subtotal += (parseFloat(item.price) * item.quantity);

          const node = document.createElement('div'); node.className='cart-item';
          node.innerHTML = `
            <div class="cart-item-image"><img src="${item.image?item.image:'/placeholder.svg?height=100&width=100'}" alt="${item.name}"/></div>
            <div class="cart-item-details">
              <span class="cart-item-shop">${item.shopId || ''}</span>
              <h3 class="cart-item-name">${item.name}</h3>
              <span class="cart-item-variant"></span>
              <div class="cart-item-quantity">
                <div class="quantity-control">
                  <button class="qty-decrease">-</button>
                  <input type="number" class="qty-input" value="${item.quantity}" min="1" />
                  <button class="qty-increase">+</button>
                </div>
                <button class="remove-item" data-id="${item.cartId}">Remove</button>
              </div>
            </div>
            <div class="cart-item-price">
              <span class="price">${formatMoney(item.price * item.quantity)}</span>
              <span class="unit-price">${formatMoney(item.price)} each</span>
            </div>
          `;

          // attach handlers
          node.querySelector('.qty-decrease').addEventListener('click', async ()=>{
            const input = node.querySelector('.qty-input'); let v = parseInt(input.value); if(v>1){ v--; input.value = v; await api({data_type:'update_cart', cartId: item.cartId, quantity: v}); loadCart(); }
          });
          node.querySelector('.qty-increase').addEventListener('click', async ()=>{
            const input = node.querySelector('.qty-input'); let v = parseInt(input.value); v++; input.value = v; await api({data_type:'update_cart', cartId: item.cartId, quantity: v}); loadCart();
          });
          node.querySelector('.remove-item').addEventListener('click', async ()=>{
            await api({data_type:'remove_from_cart', cartId: item.cartId}); loadCart();
          });

          list.appendChild(node);
        });

        countEl.textContent = items;
        itemsEl.textContent = items;
        subtotalEl.textContent = formatMoney(subtotal);
        // delivery fixed simple
        const delivery = subtotal > 0 ? 4.98 : 0;
        document.querySelector('.summary-delivery').textContent = formatMoney(delivery);
        const total = subtotal - 0 + delivery;
        totalEl.textContent = formatMoney(total);
      }

      document.querySelector('.clear-cart').addEventListener('click', async ()=>{ if(confirm('Clear cart?')){ await api({data_type:'clear_cart'}); loadCart(); } });

      // init
      loadCart();
    </script>
          </div>
          <div class="summary-row">
            <span>Delivery Fee</span>
            <span class="summary-delivery">$0.00</span>
          </div>
          <div class="summary-row discount">
            <span>Discount</span>
            <span class="summary-discount">$0.00</span>
          </div>

          <form class="coupon-form">
            <input type="text" placeholder="Enter coupon code" />
            <button type="submit">Apply</button>
          </form>

          <div class="summary-total">
            <span>Total</span>
            <span class="summary-total-amount">$0.00</span>
          </div>

          <a href="checkout.html" class="btn btn-primary checkout-btn">
            Proceed to Checkout
          </a>

          <a
            href="../../index.html"
            class="btn btn-secondary"
            style="width: 100%; margin-top: 10px"
          >
            Continue Shopping
          </a>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-section footer-about">
          <div class="footer-logo">
            <img src="../../assets/images/logo.png" alt="GoGrocery" />
          </div>
          <p class="footer-description">
            Your favorite local grocery stores, delivered fresh to your
            doorstep.
          </p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="../../index.html">Home</a></li>
            <li><a href="shops.html">Browse Shops</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Customer Service</h4>
          <ul>
            <li><a href="#">Help Center</a></li>
            <li><a href="#">Contact Us</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Legal</h4>
          <ul>
            <li><a href="#">Terms of Service</a></li>
            <li><a href="#">Privacy Policy</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 GoGrocery. All rights reserved.</p>
      </div>
    </footer>

    <script>
      // Quantity buttons
      document.querySelectorAll(".qty-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const input = this.parentElement.querySelector(".qty-input");
          let value = parseInt(input.value);
          if (this.textContent === "-" && value > 1) {
            input.value = value - 1;
          } else if (this.textContent === "+") {
            input.value = value + 1;
          }
        });
      });
    </script>
  </body>
</html>
