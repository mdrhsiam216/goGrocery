<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - GoGrocery</title>
    <link rel="stylesheet" href="../../assets/css/common/base.css" />
    <link rel="stylesheet" href="../../assets/css/common/components.css" />
    <link rel="stylesheet" href="../../assets/css/customer/layout.css" />
    <style>
        .checkout-main {
            background: #f5f5f5;
            padding: 2rem 0;
            min-height: 100vh;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            padding: 0 1rem;
        }

        .checkout-left {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .checkout-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
        }

        .address-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .address-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .address-field label {
            font-weight: 500;
            color: #333;
        }

        .address-field input,
        .address-field textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .address-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .payment-options {
            display: flex;
            gap: 1.5rem;
            margin: 1rem 0;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option input[type="radio"] {
            cursor: pointer;
        }

        .payment-option.selected {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .order-review {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .order-group {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .shop-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            color: #333;
        }

        .item-qty {
            font-size: 0.9rem;
            color: #666;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary);
        }

        .checkout-summary {
            position: sticky;
            top: 100px;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 0.95rem;
        }

        .summary-row.total {
            border-top: 2px solid #f0f0f0;
            padding-top: 1rem;
            margin-top: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .checkout-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .checkout-actions .btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
        }

        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .checkout-summary {
                position: static;
            }

            .payment-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="../../index.html" class="header-logo">
                <img src="../../assets/images/logo.png" alt="GoGrocery" />
            </a>
            <div class="header-actions">
                <a href="cart.html" class="header-link cart-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="8" cy="21" r="1"></circle>
                        <circle cx="19" cy="21" r="1"></circle>
                        <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                    </svg>
                    <span class="cart-badge">0</span>
                </a>
                <div class="user-menu">
                    <button class="user-menu-btn">
                            <img src="/goGrocery/assets/images/placeholder.svg?height=32&width=32" alt="User" class="user-avatar" />
                        <span>User</span>
                    </button>
                    <div class="user-menu-dropdown">
                        <a href="../common/profile.html">My Profile</a>
                        <a href="orders.html">My Orders</a>
                        <a href="../common/change-password.html">Change Password</a>
                        <a href="#" class="logout">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="checkout-main">
        <div class="checkout-container">
            <!-- Left Section -->
            <div class="checkout-left">
                <!-- Delivery Address -->
                <div class="checkout-section">
                    <h2 class="section-title">Delivery Address</h2>
                    <div class="address-section">
                        <div class="address-field">
                            <label>Full Name</label>
                            <input type="text" class="address-name" placeholder="Enter your full name" />
                        </div>
                        
                        <div class="address-field">
                            <label>Address</label>
                            <textarea class="address-location" placeholder="Enter your delivery address"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-section">
                    <h2 class="section-title">Payment Method</h2>
                    <div class="payment-options">
                        <label class="payment-option selected">
                            <input type="radio" name="payment" value="cash" checked />
                            <span>Cash on Delivery</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment" value="online" />
                            <span>Online Payment</span>
                        </label>
                    </div>
                </div>

                <!-- Order Review -->
                <div class="checkout-section">
                    <h2 class="section-title">Order Review</h2>
                    <div class="order-review">
                        <!-- Orders by shop will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Section - Summary -->
            <div class="checkout-summary">
                <div class="summary-title">Order Summary</div>
                
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span class="summary-subtotal">$0.00</span>
                </div>

                <div class="summary-row discount" style="display: none; color: #28a745;">
                    <span>Discount</span>
                    <span class="summary-discount">-$0.00</span>
                </div>

                <div class="summary-row coupon-applied" style="display: none;">
                    <span class="coupon-code"></span>
                    <span>Applied</span>
                </div>

                <div class="summary-row total">
                    <span>Total</span>
                    <span class="summary-total">$0.00</span>
                </div>

                <button class="place-order-btn btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
                    Place Order
                </button>

                <a href="cart.html" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem; text-align: center; display: inline-block;">
                    Back to Cart
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section footer-about">
                <div class="footer-logo">
                    <img src="../../assets/images/logo.png" alt="GoGrocery" />
                </div>
                <p class="footer-description">
                    Your favorite local grocery stores, delivered fresh to your doorstep.
                </p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="shops-and-products.html">Browse Shops</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Customer Service</h4>
                <ul>
                    <li><a href="#">Help Center</a></li>
                    <li><a href="#">Contact Us</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 GoGrocery. All rights reserved.</p>
        </div>
    </footer>

    <script>
        async function api(body){
            try{
                console.log('API Request:', body);
                const res = await fetch('../../backend/api.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                console.log('API Response status:', res.status);
                const text = await res.text();
                console.log('API Response text:', text);
                try {
                    return JSON.parse(text);
                } catch(e) {
                    console.error('Failed to parse JSON:', e);
                    return null;
                }
            }catch(e){ 
                console.error('API Error:', e);
                return null; 
            }
        }

        function formatMoney(v){ 
            return '$' + parseFloat(v).toFixed(2); 
        }

        let cartItems = [];
        let appliedCoupon = null;
        let discountPercentage = 0;

        async function loadCheckoutData(){
            // Load user info and address
            const userRes = await api({data_type: 'user_info'});
            if(!userRes || !userRes.logged_in){
                window.location.href = '../common/login.html';
                return;
            }

            const user = userRes.user || {};
            document.querySelector('.address-name').value = user.name || '';
            document.querySelector('.address-location').value = user.location || '';

            // Load cart items
            const cartRes = await api({data_type: 'get_cart'});
            console.log('Checkout Cart Response:', cartRes);
            if(!cartRes || !cartRes.items || cartRes.items.length === 0){
                document.querySelector('.order-review').innerHTML = '<p>Your cart is empty</p>';
                return;
            }

            cartItems = cartRes.items;
            console.log('Cart Items:', cartItems);

            // Group items by shop
            const shopGroups = {};
            cartItems.forEach(item => {
                const shopId = item.shopId || 'unknown';
                const shopName = item.shop_name || 'Shop';
                if(!shopGroups[shopId]){
                    shopGroups[shopId] = {
                        shopId: shopId,
                        shopName: shopName,
                        items: [],
                        subtotal: 0
                    };
                }
                shopGroups[shopId].items.push(item);
                shopGroups[shopId].subtotal += (parseFloat(item.price) * item.quantity);
            });

            // Render order review
            const review = document.querySelector('.order-review');
            review.innerHTML = '';
            Object.values(shopGroups).forEach(shop => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'order-group';
                
                let itemsHTML = `<div class="shop-name">${shop.shopName}</div>`;
                shop.items.forEach(item => {
                    itemsHTML += `
                        <div class="order-item">
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-qty">Qty: ${item.quantity}</div>
                            </div>
                            <div class="item-price">${formatMoney(item.price * item.quantity)}</div>
                        </div>
                    `;
                });
                
                groupDiv.innerHTML = itemsHTML;
                review.appendChild(groupDiv);
            });

            // Load summary from sessionStorage (set by cart.js)
            const subtotal = parseFloat(sessionStorage.getItem('cart_subtotal') || '0');
            const discount = parseFloat(sessionStorage.getItem('cart_discount') || '0');
            const total = parseFloat(sessionStorage.getItem('cart_total') || '0');
            appliedCoupon = sessionStorage.getItem('applied_coupon') || null;
            discountPercentage = parseFloat(sessionStorage.getItem('discount_percentage') || '0');

            document.querySelector('.summary-subtotal').textContent = formatMoney(subtotal);
            document.querySelector('.summary-total').textContent = formatMoney(total);

            if(discount > 0){
                document.querySelector('.summary-discount').textContent = '-' + formatMoney(discount);
                document.querySelector('.discount').style.display = 'flex';
            }

            if(appliedCoupon){
                document.querySelector('.coupon-code').textContent = `Coupon: ${appliedCoupon}`;
                document.querySelector('.coupon-applied').style.display = 'flex';
            }
        }

        // Payment method toggle
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
                e.target.closest('.payment-option').classList.add('selected');
            });
        });

        // Place order handler
        document.querySelector('.place-order-btn').addEventListener('click', async () => {
            const name = document.querySelector('.address-name').value.trim();
            const location = document.querySelector('.address-location').value.trim();
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            if(!name || !location){
                alert('Please fill in all address fields');
                return;
            }

            if(cartItems.length === 0){
                alert('Your cart is empty');
                return;
            }

            // Group items by shop and create orders
            const shopGroups = {};
            let totalAmount = 0;
            cartItems.forEach(item => {
                const shopId = item.shopId || 'unknown';
                const shopName = item.shop_name || 'Shop';
                if(!shopGroups[shopId]){
                    shopGroups[shopId] = {
                        shopId: shopId,
                        shopName: shopName,
                        items: [],
                        amount: 0
                    };
                }
                shopGroups[shopId].items.push(item);
                shopGroups[shopId].amount += (parseFloat(item.price) * item.quantity);
            });

            try {
                // Create order for each shop
                const subtotal = parseFloat(sessionStorage.getItem('cart_subtotal') || '0');
                const discount = parseFloat(sessionStorage.getItem('cart_discount') || '0');
                const discountPercentage = parseFloat(sessionStorage.getItem('discount_percentage') || '0');

                for(const shopId in shopGroups){
                    const shop = shopGroups[shopId];
                    const shopDiscount = (shop.amount * discountPercentage) / 100;
                    const shopTotal = shop.amount - shopDiscount;

                    const orderData = {
                        data_type: 'create_order',
                        shopId: shop.shopId,
                        amount: shopTotal,
                        method: paymentMethod,
                        voucher: appliedCoupon || null,
                        items: shop.items.map(item => ({
                            productId: item.id,
                            quantity: item.quantity
                        }))
                    };

                    // Ensure numeric types and stringify for reliable logging
                    orderData.shopId = parseInt(orderData.shopId);
                    orderData.amount = parseFloat(orderData.amount);
                    orderData.items = orderData.items.map(i => ({ productId: parseInt(i.productId), quantity: parseInt(i.quantity) }));

                    console.log('Sending order data JSON:', JSON.stringify(orderData));

                    const orderRes = await api(orderData);

                    console.log('Order response:', orderRes);

                    if(!orderRes || !orderRes.order_id){
                        console.error('Full response:', JSON.stringify(orderRes));
                        const errorMsg = orderRes?.message || JSON.stringify(orderRes);
                        alert('Failed to create order for ' + shop.shopName + '\n' + errorMsg);
                        console.error('Order failed:', orderRes);
                        return;
                    }
                }

                // Clear cart
                await api({data_type: 'clear_cart'});
                
                // Clear sessionStorage
                sessionStorage.removeItem('cart_subtotal');
                sessionStorage.removeItem('cart_discount');
                sessionStorage.removeItem('cart_total');
                sessionStorage.removeItem('applied_coupon');
                sessionStorage.removeItem('discount_percentage');

                alert('Order placed successfully!');
                window.location.href = 'orders.html';
            } catch(e){
                console.error(e);
                alert('Error placing order');
            }
        });

        async function updateHeader(){
            const j = await api({data_type:'user_info'});
            if(j && j.logged_in){
                const user = j.user || {};
                const btn = document.querySelector('.user-menu-btn');
                const userSpan = btn ? btn.querySelector('span') : null;
                const userImg = btn ? btn.querySelector('img') : null;
                
                if(userSpan) userSpan.textContent = user.name || 'User';
                if(userImg && user.image) userImg.src = user.image;

                const cartRes = await api({data_type:'cart_count'});
                const badge = document.querySelector('.cart-badge');
                if(badge && cartRes && cartRes.count !== undefined){
                    badge.textContent = cartRes.count;
                }
            } else {
                window.location.href = '../common/login.html';
            }

            const logoutBtn = document.querySelector('.logout');
            if(logoutBtn){
                logoutBtn.addEventListener('click', async (e)=>{
                    e.preventDefault();
                    await api({data_type:'logout'});
                    window.location.href = '../common/login.html';
                });
            }
        }

        // Initialize page
        updateHeader();
        loadCheckoutData();
    </script>
</body>
</html>
      
