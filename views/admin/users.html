<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management - GoGrocery Admin</title>
    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/common/base.css" />
    <link rel="stylesheet" href="../../assets/css/common/components.css" />
    <link rel="stylesheet" href="../../assets/css/admin/layout.css" />
    <link rel="stylesheet" href="../../assets/css/admin/users.css" />
  </head>
  <body>
    <div class="admin-dashboard">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <nav class="admin-sidebar-nav">
          <div class="admin-nav-section">
            <p class="admin-nav-title">Main</p>
            <a href="dashboard.html" class="admin-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                />
              </svg>
              Dashboard
            </a>
          </div>

          <div class="admin-nav-section">
            <p class="admin-nav-title">Management</p>
            <a href="users.html" class="admin-nav-link active">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              Users
            </a>
            <a href="shops.html" class="admin-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                />
              </svg>
              Shops
            </a>
          </div>

          <div class="admin-nav-section">
            <p class="admin-nav-title">Settings</p>

            <a href="../common/profile.html" class="admin-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              My Profile
            </a>
            <a href="../common/login.html" class="admin-nav-link">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              Logout
            </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        <!-- Top Header -->
        <header class="admin-top-header">
          <div class="admin-header-left">
            <button class="admin-sidebar-toggle" id="sidebarToggle">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <h1 class="admin-page-title">User Management</h1>
          </div>
          <div class="admin-header-right">
            <div class="admin-search">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <input type="text" placeholder="Search anything..." />
            </div>

            <div class="admin-header-profile">
              <img
                src="/placeholder.svg?height=40&width=40"
                alt="Admin"
                class="admin-avatar"
              />
              <div class="admin-profile-info">
                <p class="admin-profile-name">John Admin</p>
                <p class="admin-profile-role">Super Admin</p>
              </div>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <div class="admin-content">
          <!-- Breadcrumb -->
          <nav class="admin-breadcrumb">
            <a href="dashboard.html">Dashboard</a>
            <span>/</span>
            <span class="current">Users</span>
          </nav>

          <!-- Page Header -->
          <div class="admin-page-header">
            <div class="admin-page-header-info">
              <h1>User Management</h1>
            </div>
            <div class="admin-page-actions">
              <a href="add_user.html" class="btn btn-primary">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 4v16m8-8H4"
                  />
                </svg>
                Add User
              </a>
            </div>
          </div>

          <!-- Users Table -->
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Role</th>
                  <th>change role</th>
                  <th>action</th>
                </tr>
              </thead>
              <tbody>
                <!-- PHP: Loop through users -->
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Sidebar Overlay for Mobile -->
      <div class="admin-sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <script>
      // Sidebar Toggle
      const sidebar = document.querySelector(".admin-sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarOverlay = document.getElementById("sidebarOverlay");

      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("active");
        sidebarOverlay.classList.toggle("active");
      });

      sidebarOverlay.addEventListener("click", () => {
        sidebar.classList.remove("active");
        sidebarOverlay.classList.remove("active");
      });
    </script>
    <script>
      // Admin page: load users dynamically and protect access
      (async function () {
        try {
          const r = await fetch("../../backend/api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data_type: "user_info" }),
          });
          const j = await r.json();
          if (!j.logged_in || j.user.role !== "admin") {
            window.location.href = "../../views/common/login.html";
            return;
          }
          // set admin profile info
          if (j.user) {
            const adminAvatar = document.querySelector(".admin-avatar");
            if (adminAvatar && j.user.image) adminAvatar.src = j.user.image;
            if (j.user.name)
              document.querySelector(".admin-profile-name").textContent =
                j.user.name;
          }

          const usersRes = await fetch("../../backend/api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data_type: "get_users" }),
          }).then((r) => r.json());
          const tbody = document.querySelector(".admin-table tbody");
          tbody.innerHTML = "";
          if (usersRes && usersRes.users) {
            usersRes.users.forEach((u) => {
              const tr = document.createElement("tr");
              const avatarSrc = u.image
                ? u.image
                : "/placeholder.svg?height=42&width=42";
              tr.innerHTML = `
              <td><div class="user-cell"><img src="${avatarSrc}" class="user-cell-avatar"><div class="user-cell-info"><h4>${u.name}</h4><p>${u.email}</p></div></div></td>
              <td><span class="role-badge ${u.role}">${u.role}</span></td>
              <td></td>
              <td></td>
              <td><div class="table-actions"><button class="table-action-btn role-change" data-id="${u.id}">Change Role</button><button class="table-action-btn delete-user" data-id="${u.id}">Delete</button></div></td>
            `;
              tbody.appendChild(tr);
            });

            // attach handlers
            tbody.querySelectorAll(".role-change").forEach((btn) => {
              btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const role = prompt(
                  "Enter role (admin,customer,manager,shop):",
                );
                if (!role) return;
                await fetch("../../backend/api.php", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    data_type: "update_user",
                    id: id,
                    role: role,
                  }),
                });
                location.reload();
              });
            });
            tbody.querySelectorAll(".delete-user").forEach((btn) => {
              btn.addEventListener("click", async () => {
                if (confirm("Delete user?")) {
                  await fetch("../../backend/api.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      data_type: "delete_user",
                      id: btn.dataset.id,
                    }),
                  });
                  location.reload();
                }
              });
            });
          }
        } catch (e) {
          console.warn(e);
        }
      })();
    </script>
  </body>
</html>
